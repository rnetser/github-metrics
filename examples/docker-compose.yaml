# GitHub Metrics Service - Docker Compose Example
#
# Standalone metrics server for GitHub webhook event tracking and visualization.
# This service receives webhook events and stores metrics in PostgreSQL.
#
# Usage:
#   1. Copy this file to your deployment directory
#   2. Create .env file with POSTGRES_PASSWORD=<your-secure-password>
#   3. Run: docker-compose up -d

services:
  # PostgreSQL database for metrics storage
  github-metrics-postgres:
    image: postgres:16-alpine
    container_name: github-metrics-postgres
    environment:
      POSTGRES_DB: github_metrics
      POSTGRES_USER: metrics
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}  # (required) Set in .env file
    volumes:
      - "./postgres-data:/var/lib/postgresql/data"
    ports:
      # Bind to localhost only - prevents external network access
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U metrics -d github_metrics"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # GitHub Metrics service
  github-metrics:
    image: ghcr.io/myk-org/github-metrics:latest
    container_name: github-metrics
    environment:
      # Database configuration
      METRICS_DB_HOST: github-metrics-postgres  # (default: localhost) - use container name in compose
      METRICS_DB_PORT: "5432"  # (default: 5432)
      METRICS_DB_NAME: github_metrics  # (required)
      METRICS_DB_USER: metrics  # (required)
      METRICS_DB_PASSWORD: ${POSTGRES_PASSWORD}  # (required)
      METRICS_DB_POOL_SIZE: "20"  # (default: 20)
      # Server configuration
      METRICS_SERVER_HOST: "0.0.0.0"  # (default: 0.0.0.0)
      METRICS_SERVER_PORT: "8080"  # (default: 8080)
      METRICS_SERVER_WORKERS: "4"  # (default: 4)
      # Webhook security (leave empty by default, user can set)
      METRICS_WEBHOOK_SECRET: ""  # (optional) Secret for webhook signature validation
      METRICS_VERIFY_GITHUB_IPS: "false"  # (default: false)
      METRICS_VERIFY_CLOUDFLARE_IPS: "false"  # (default: false)
      # GitHub webhook setup (leave empty/false by default)
      METRICS_SETUP_WEBHOOK: "false"  # (default: false) Enable automatic webhook setup
      METRICS_GITHUB_TOKEN: ""  # (optional) Required if METRICS_SETUP_WEBHOOK=true
      METRICS_WEBHOOK_URL: ""  # (optional) URL where this service receives webhooks
      # (optional) Comma-separated org/repo list. Use multi-line >- for readability.
      METRICS_REPOSITORIES: >-
        org/repo1,
        org/repo2
    ports:
      - "8080:8080"
    depends_on:
      github-metrics-postgres:
        condition: service_healthy
    restart: unless-stopped
